<html>

<head>
    <meta charset="UTF-8">
    </meta>
    <meta name="viewport" content="width=device-width, initial-scale=1,maxium-scale=1" />
    <title>台北一日遊-首頁 </title>

    
    <link href="index.css" rel="stylesheet" type="text/css">
    <!-- 離線的 要擺在HTML同一個資料夾 -->
</head>


<body>
    <div class="top1">
        <div class="top">
            <div class="top2">

                <div class="top_left_logo">台北一日遊
                </div>
                <div class="top_right">

                    <div class="top_right_item">預定行程</div>
                    <div class="top_right_item">登入/註冊 </div>
                </div>
            </div>
        </div>
    </div>

    <div></div>

    <div class="head">


        <div class="head2">

            <div class="head_middle">
                <div class="head_middle_text1">輕鬆享受台北一日悠閒</div>
                <div class="head_middle_text2">探索每個角落，體驗城市的深度旅遊行程</div>
                <div class="head_middle_search_box">
                    <input class="head_middle_search_input" placeholder="輸入景點名稱查詢" id='AttrationKeyword'>
                    <button class="head_middle_search_button" type="button" onclick="getDataAttrationKeyword()"><img
                            src="icon_search.png"> </button>
                </div>

            </div>
            <div> </div>
        </div>
        <div class="headimg">
        </div>
    </div>
    </div>

    <!-- 從無到有產生景點方塊 -->
    <main class="main" id="main">
    </main>

    <!-- A footer for the page. -->
    </div>
    <footer class="footer" id="foot">
        <div id="keywordfoot"></div>
        <div class="footer_text">
            <p>COPYRIGHT © 2021 台北一日遊</p>
    </footer>
</body>


<script>

    // Intersection Observer  //  Infinite Scroll  觀察 foot
    // https://shubo.io/intersection-observer-api/
    const foot = document.getElementById('foot');
    const callback = (entries, observer) => {
        entries.forEach(entry => {
            console.log(entry);
            if (entry.isIntersecting) {
                add()
            }
        }
        );
    };
    const observer = new IntersectionObserver(callback);

    //觀察keywordfoot
    const keywordfoot = document.getElementById('keywordfoot');
    const keywordcallback = (entries, observer) => {
        entries.forEach(entry => {
            console.log('keywordfoot', entry);
            if (entry.isIntersecting) {
                addkeyword()
            }
        }
        );
    };
    const keywordobserver = new IntersectionObserver(keywordcallback);

    // 一打開網頁 載入首頁
    fetch("http://3.115.236.143:3000/api/attractions")
        .then((result) => {
            return result.json();//將資料用JSON 的格式用物件和陣列的組合
        })
        .then((result) => {
            // 載入網頁時 從無到有載入第一頁的container
            for (d = 1; d < 13; d++) {
                //以下都一樣~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                let containerdiv = document.createElement("div");
                containerdiv.id = "container" + String(d);
                containerdiv.className = "container";
                document.getElementById("main").appendChild(containerdiv);

                let picdiv = document.createElement("div");
                picdiv.className = "Pic";
                picdiv.id = "pic" + String(d);
                document.getElementById("container" + String(d)).appendChild(picdiv);

                let titlediv = document.createElement("div");
                titlediv.className = "Title";
                titlediv.id = "view" + String(d);
                document.getElementById("container" + String(d)).appendChild(titlediv);

                let containerbottom = document.createElement("div");
                containerbottom.className = "containerbottom";
                containerbottom.id = "containerbottom" + String(d);
                document.getElementById("container" + String(d)).appendChild(containerbottom);

                let mrtdiv = document.createElement("div");
                mrtdiv.className = "mrtdiv";
                mrtdiv.id = "mrtdiv" + String(d);
                document.getElementById("containerbottom" + String(d)).appendChild(mrtdiv);

                let catediv = document.createElement("div");
                catediv.className = "catediv";
                catediv.id = "catediv" + String(d);
                document.getElementById("containerbottom" + String(d)).appendChild(catediv);
            }

            // 載入網頁時 將照片和景點塞入 從第一頁的container
            function Viewdata(view, id) {
                this.name = result.data[i].name;
                let x = document.createElement("p");
                x.setAttribute("class", "Title");
                let t = document.createTextNode(this.name);
                x.appendChild(t);
                document.getElementById(id).appendChild(x);
            }

            function Picdata(pic, imgid) {
                this.pic = result.data[i].images[0];
                let imgTag = document.createElement("img");
                imgTag.src = this.pic;
                imgTag.setAttribute("class", "Pic");
                let mm = document.getElementById(imgid);
                mm.appendChild(imgTag);//將id="pic " 插入 img 標籤

                //將圖片加入超連結
                dataid = result.data[i].id; //取得data 的id
                let linkTag = document.createElement("a"); //建立HTML a 標籤
                linkTag.href = "http://3.115.236.143:3000/attraction/" + dataid; // 建立 a href=http://3.115.236.143:3000/attraction/<id>
                mm.appendChild(linkTag); //將id="pic " 插入a標籤
                linkTag.appendChild(imgTag) //將 a 標籤 插入 img
            }

            function mrtdata(mrt, mrtdiv) {
                this.mrt = result.data[i].mrt;
                let m = document.createElement("p");
                m.setAttribute("class", "mrtdiv");
                let r = document.createTextNode(this.mrt);
                m.appendChild(r);
                document.getElementById(mrtdiv).appendChild(m);
            }


            function catedata(cate, catediv) {
                this.catediv = result.data[i].category;
                let c = document.createElement("p");
                c.setAttribute("class", "catediv");
                let a = document.createTextNode(this.catediv);
                c.appendChild(a);
                document.getElementById(catediv).appendChild(c);
            }
            //以上都一樣~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
            for (i = 0; i < 12; i++) {
                Viewdata(i, "view" + String(i + 1));
                Picdata(i, "pic" + String(i + 1));
                mrtdata(i, "mrtdiv" + String(i + 1));
                catedata(i, "catediv" + String(i + 1));
            }
            //設一段延遲等網頁載完打開觀察
            setTimeout(observer.observe(foot), 2000)

        })


    // LOAD MORE. .載入下一頁 ，從下一頁的第一筆取DATA
    let loadcount = 0
    function add() {
        loadcount = loadcount + 1
        let loadnum = loadcount * 12
        // console.log("載入數字:" + loadnum)

        fetch("http://3.115.236.143:3000/api/attractions?page=" + String(loadcount))
            .then((result) => {
                return result.json();//將資料用JSON 的格式用物件和陣列的組合
            })
            .then((result) => {
                //loadnum + 1+result.data.length 防止多加最後一頁多的div
                for (d = loadnum + 1; d < loadnum + 1 + result.data.length; d++) {

                    //以下都一樣~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                    let containerdiv = document.createElement("div");
                    containerdiv.id = "container" + String(d);
                    containerdiv.className = "container";
                    document.getElementById("main").appendChild(containerdiv);

                    let picdiv = document.createElement("div");
                    picdiv.className = "Pic";
                    picdiv.id = "pic" + String(d);
                    document.getElementById("container" + String(d)).appendChild(picdiv);

                    let titlediv = document.createElement("div");
                    titlediv.className = "Title";
                    titlediv.id = "view" + String(d);
                    document.getElementById("container" + String(d)).appendChild(titlediv);

                    let containerbottom = document.createElement("div");
                    containerbottom.className = "containerbottom";
                    containerbottom.id = "containerbottom" + String(d);
                    document.getElementById("container" + String(d)).appendChild(containerbottom);

                    let mrtdiv = document.createElement("div");
                    mrtdiv.className = "mrtdiv";
                    mrtdiv.id = "mrtdiv" + String(d);
                    document.getElementById("containerbottom" + String(d)).appendChild(mrtdiv);

                    let catediv = document.createElement("div");
                    catediv.className = "catediv";
                    catediv.id = "catediv" + String(d);
                    document.getElementById("containerbottom" + String(d)).appendChild(catediv);
                };


                function Viewdata(view, id) {
                    this.name = result.data[i].name;
                    let x = document.createElement("p");
                    x.setAttribute("class", "Title");
                    let t = document.createTextNode(this.name);
                    x.appendChild(t);
                    document.getElementById(id).appendChild(x);
                }

                function Picdata(pic, imgid) {
                    this.pic = result.data[i].images[0];
                    let imgTag = document.createElement("img");
                    imgTag.src = this.pic;
                    imgTag.setAttribute("class", "Pic");
                    let mm = document.getElementById(imgid);
                    mm.appendChild(imgTag);

                    //將圖片加入超連結
                    dataid = result.data[i].id; //取得data 的id
                    let linkTag = document.createElement("a"); //建立HTML a 標籤
                    linkTag.href = "http://3.115.236.143:3000/attraction/" + dataid; // 建立 a href=http://3.115.236.143:3000/attraction/<id>
                    mm.appendChild(linkTag); //將id="pic " 插入a標籤
                    linkTag.appendChild(imgTag) //將 a 標籤 插入 img
                };


                function mrtdata(mrt, mrtdiv) {
                    this.mrt = result.data[i].mrt;
                    let m = document.createElement("p");
                    m.setAttribute("class", "mrtdiv");
                    let r = document.createTextNode(this.mrt);
                    m.appendChild(r);
                    document.getElementById(mrtdiv).appendChild(m);
                }


                function catedata(cate, catediv) {
                    this.catediv = result.data[i].category;
                    let c = document.createElement("p");
                    c.setAttribute("class", "catediv");
                    let a = document.createTextNode(this.catediv);
                    c.appendChild(a);
                    document.getElementById(catediv).appendChild(c);
                }

                //以上都一樣~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

                for (i = 0; i < result.data.length; i++) {
                    Viewdata(i, "view" + String(i + loadnum + 1));
                    Picdata(i, "pic" + String(i + loadnum + 1));
                    mrtdata(i, "mrtdiv" + String(i + loadnum + 1));
                    catedata(i, "catediv" + String(i + loadnum + 1));
                }


                //最後一頁就關掉觀察foot
                if (result.nextPage == null) {
                    console.log("確認進入nextPage == null 關掉foot ", observer.unobserve(foot));
                    observer.unobserve(foot)
                }
            });
    }


    // Part 2 - 4：完成關鍵字搜尋功能  : 查詢資料景點名字  id='AttrationKeyword'
    function getDataAttrationKeyword() { //載入keyword 首頁

        //重置 載入更多頁數的數字
        keywordloadcount = 0
        loadcount = 0

        //取得關鍵字 宣告全域
        AttrationKeywordElement = document.getElementById('AttrationKeyword');
        AttrationKeyword = AttrationKeywordElement.value;
        console.log("關鍵字", AttrationKeyword)

        //只要一按搜尋就關閉foot，防止沒有跑到最後一頁關掉foot 就按搜尋
        observer.unobserve(foot);

        // 刪除main下面所有子節點 清空頁面
        let delmain = document.getElementById("main");
        while (delmain.firstChild) {
            delmain.removeChild(delmain.firstChild);
        }

        fetch("http://3.115.236.143:3000/api/attractions?keyword=" + AttrationKeyword)
            .then(function (response) {
                return response.json();
            })
            .then(function (result) {

                //如果搜尋資料長度=0代表沒有關鍵字，網頁顯示找無資料
                if (result.data.length == 0) {
                    let nodata = document.createElement("p");// 加入P 標籤
                    nodata.id = "nodata"// P 標籤的id = nodata
                    nodata.setAttribute("class", "top_right_item");// id = nodata ,給他一個class 類別那就top_right_item好了
                    let t = document.createTextNode("沒有結果");//顯示nodata的文字
                    nodata.appendChild(t);//顯示nodata的文字 插入在nodata後 將nodata 插入在id = main 的下面 就可以顯示在畫面上
                    document.getElementById("main").appendChild(nodata);
                }
                else {

                    // 刪除所有元素後 並確認有關鍵字，
                    // 載入網頁時 從無到有載入第一頁的container
                    for (d = 1; d < 13; d++) {

                        //以下都一樣~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                        let containerdiv = document.createElement("div");
                        containerdiv.id = "container" + String(d);
                        containerdiv.className = "container";
                        document.getElementById("main").appendChild(containerdiv);

                        let picdiv = document.createElement("div");
                        picdiv.className = "Pic";
                        picdiv.id = "pic" + String(d);
                        document.getElementById("container" + String(d)).appendChild(picdiv);

                        let titlediv = document.createElement("div");
                        titlediv.className = "Title";
                        titlediv.id = "view" + String(d);
                        document.getElementById("container" + String(d)).appendChild(titlediv);

                        let containerbottom = document.createElement("div");
                        containerbottom.className = "containerbottom";
                        containerbottom.id = "containerbottom" + String(d);
                        document.getElementById("container" + String(d)).appendChild(containerbottom);

                        let mrtdiv = document.createElement("div");
                        mrtdiv.className = "mrtdiv";
                        mrtdiv.id = "mrtdiv" + String(d);
                        document.getElementById("containerbottom" + String(d)).appendChild(mrtdiv);

                        let catediv = document.createElement("div");
                        catediv.className = "catediv";
                        catediv.id = "catediv" + String(d);
                        document.getElementById("containerbottom" + String(d)).appendChild(catediv);
                    }

                    // 載入網頁時 將照片和景點塞入 從第一頁的container
                    function Viewdata(view, id) {
                        this.name = result.data[i].name;
                        let x = document.createElement("p");
                        x.setAttribute("class", "Title");
                        let t = document.createTextNode(this.name);
                        x.appendChild(t);
                        document.getElementById(id).appendChild(x);
                    }

                    function Picdata(pic, imgid) {
                        this.pic = result.data[i].images[0];
                        let imgTag = document.createElement("img");
                        imgTag.src = this.pic;
                        imgTag.setAttribute("class", "Pic");
                        let mm = document.getElementById(imgid);
                        mm.appendChild(imgTag);

                        //將圖片加入超連結
                        dataid = result.data[i].id; //取得data 的id
                        let linkTag = document.createElement("a"); //建立HTML a 標籤
                        linkTag.href = "http://3.115.236.143:3000/attraction/" + dataid; // 建立 a href=http://3.115.236.143:3000/attraction/<id>
                        mm.appendChild(linkTag); //將id="pic " 插入a標籤
                        linkTag.appendChild(imgTag) //將 a 標籤 插入 img
                    }


                    function mrtdata(mrt, mrtdiv) {
                        this.mrt = result.data[i].mrt;
                        let m = document.createElement("p");
                        m.setAttribute("class", "mrtdiv");
                        let r = document.createTextNode(this.mrt);
                        m.appendChild(r);
                        document.getElementById(mrtdiv).appendChild(m);
                    }


                    function catedata(cate, catediv) {
                        this.catediv = result.data[i].category;
                        let c = document.createElement("p");
                        c.setAttribute("class", "catediv");
                        let a = document.createTextNode(this.catediv);
                        c.appendChild(a);
                        document.getElementById(catediv).appendChild(c);
                    }
                    //以上都一樣~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                    for (i = 0; i < 12; i++) {
                        Viewdata(i, "view" + String(i + 1));
                        Picdata(i, "pic" + String(i + 1));
                        mrtdata(i, "mrtdiv" + String(i + 1));
                        catedata(i, "catediv" + String(i + 1));
                    }

                    // 設一段延遲等載入網頁完 將關鍵字打開
                    setTimeout(keywordobserver.observe(keywordfoot), 1500)
                    // keywordobserver.observe(keywordfoot)

                }
            });
    }




    // keyword 關鍵字搜尋載入更多功能
    let keywordloadcount = 0
    function addkeyword() { //載入keyword 下一頁
        console.log("確認有addkeyword:", AttrationKeyword)
        //關掉foot
        observer.unobserve(foot);
        //載入正確的數字
        keywordloadcount = keywordloadcount + 1
        let keywordloadnum = keywordloadcount * 12


        fetch("http://3.115.236.143:3000/api/attractions?keyword=" + AttrationKeyword + "&page=" + String(keywordloadcount))
            .then((result) => {
                return result.json();//將資料用JSON 的格式用物件和陣列的組合
            })
            .then((result) => {
                //keywordloadnum + 1+result.data.length 防止多加最後一頁多的div

                for (d = keywordloadnum + 1; d < keywordloadnum + 1 + result.data.length; d++) {
                    //以下都一樣~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                    let containerdiv = document.createElement("div");
                    containerdiv.id = "container" + String(d);
                    containerdiv.className = "container";
                    document.getElementById("main").appendChild(containerdiv);

                    let picdiv = document.createElement("div");
                    picdiv.className = "Pic";
                    picdiv.id = "pic" + String(d);
                    document.getElementById("container" + String(d)).appendChild(picdiv);

                    let titlediv = document.createElement("div");
                    titlediv.className = "Title";
                    titlediv.id = "view" + String(d);
                    document.getElementById("container" + String(d)).appendChild(titlediv);

                    let containerbottom = document.createElement("div");
                    containerbottom.className = "containerbottom";
                    containerbottom.id = "containerbottom" + String(d);
                    document.getElementById("container" + String(d)).appendChild(containerbottom);

                    let mrtdiv = document.createElement("div");
                    mrtdiv.className = "mrtdiv";
                    mrtdiv.id = "mrtdiv" + String(d);
                    document.getElementById("containerbottom" + String(d)).appendChild(mrtdiv);

                    let catediv = document.createElement("div");
                    catediv.className = "catediv";
                    catediv.id = "catediv" + String(d);
                    document.getElementById("containerbottom" + String(d)).appendChild(catediv);
                };


                function Viewdata(view, id) {
                    this.name = result.data[i].name;
                    let x = document.createElement("p");
                    x.setAttribute("class", "Title");
                    let t = document.createTextNode(this.name);
                    x.appendChild(t);
                    document.getElementById(id).appendChild(x);
                }

                function Picdata(pic, imgid) {
                    this.pic = result.data[i].images[0];
                    let imgTag = document.createElement("img");
                    imgTag.src = this.pic;
                    imgTag.setAttribute("class", "Pic");
                    let mm = document.getElementById(imgid);
                    mm.appendChild(imgTag);
                    
                    //將圖片加入超連結
                    dataid = result.data[i].id; //取得data 的id
                    let linkTag = document.createElement("a"); //建立HTML a 標籤
                    linkTag.href = "http://3.115.236.143:3000/attraction/" + dataid; // 建立 a href=http://3.115.236.143:3000/attraction/<id>
                    mm.appendChild(linkTag); //將id="pic " 插入a標籤
                    linkTag.appendChild(imgTag) //將 a 標籤 插入 img
                };


                function mrtdata(mrt, mrtdiv) {
                    this.mrt = result.data[i].mrt;
                    let m = document.createElement("p");
                    m.setAttribute("class", "mrtdiv");
                    let r = document.createTextNode(this.mrt);
                    m.appendChild(r);
                    document.getElementById(mrtdiv).appendChild(m);
                }


                function catedata(cate, catediv) {
                    this.catediv = result.data[i].category;
                    let c = document.createElement("p");
                    c.setAttribute("class", "catediv");
                    let a = document.createTextNode(this.catediv);
                    c.appendChild(a);
                    document.getElementById(catediv).appendChild(c);
                }
                //以上都一樣~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

                for (i = 0; i < result.data.length; i++) {
                    Viewdata(i, "view" + String(i + keywordloadnum + 1));
                    Picdata(i, "pic" + String(i + keywordloadnum + 1));
                    mrtdata(i, "mrtdiv" + String(i + keywordloadnum + 1));
                    catedata(i, "catediv" + String(i + keywordloadnum + 1));
                }

                // keyword 最後一頁關掉keywordfoot
                if (result.nextPage == null) {
                    console.log("確認進入nextPage == null 關掉 keywordfoot ")
                    keywordobserver.unobserve(keywordfoot);
                }
            });
    }

</script>



</html>